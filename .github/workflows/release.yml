name: Build and Release
on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Build
        run: |
          npm install
          npm run build

      - name: Determine release type
        id: release_type
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "type=full" >> $GITHUB_OUTPUT
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          else
            echo "type=pre" >> $GITHUB_OUTPUT
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          fi

      - name: Get current version
        id: version
        run: |
          CURRENT_VERSION=$(jq -r '.version' manifest.json)
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT

      - name: Calculate new version (full release only)
        if: steps.release_type.outputs.type == 'full'
        id: new_version
        run: |
          CURRENT="${{ steps.version.outputs.current }}"
          IFS='.' read -r -a parts <<< "$CURRENT"
          MAJOR="${parts[0]}"
          MINOR="${parts[1]}"
          PATCH="${parts[2]}"
          
          case "${{ github.event.inputs.release_type }}" in
            major)
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
            minor)
              NEW_VERSION="${MAJOR}.$((MINOR + 1)).0"
              ;;
            patch)
              NEW_VERSION="${MAJOR}.${MINOR}.$((PATCH + 1))"
              ;;
          esac
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Set release version
        id: final_version
        run: |
          if [ "${{ steps.release_type.outputs.type }}" == "full" ]; then
            VERSION="${{ steps.new_version.outputs.version }}"
          else
            CURRENT_VERSION="${{ steps.version.outputs.current }}"
            
            # Count all existing pre-release tags for this base version
            # This includes tags that may have had their releases deleted
            EXISTING_COUNT=$(git tag -l "${CURRENT_VERSION}-pre-release.*" | wc -l)
            NEXT_COUNT=$((EXISTING_COUNT + 1))
            
            SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
            VERSION="${CURRENT_VERSION}-pre-release.${NEXT_COUNT}-${SHORT_SHA}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=$VERSION" >> $GITHUB_OUTPUT

      - name: Update manifest files (full release only)
        if: steps.release_type.outputs.type == 'full'
        run: |
          NEW_VERSION="${{ steps.final_version.outputs.version }}"
          
          jq --arg version "$NEW_VERSION" '.version = $version' manifest.json > manifest.tmp
          mv manifest.tmp manifest.json
          
          MIN_VERSION=$(jq -r '.minAppVersion' manifest.json)
          jq --arg version "$NEW_VERSION" --arg min "$MIN_VERSION" \
            '. + {($version): $min}' versions.json > versions.tmp
          mv versions.tmp versions.json

      - name: Generate changelog
        id: changelog
        run: |
          if [ "${{ steps.release_type.outputs.type }}" == "full" ]; then
            LAST_TAG=$(git describe --tags --abbrev=0 --match="[0-9]*.[0-9]*.[0-9]*" 2>/dev/null || echo "")
            if [ -z "$LAST_TAG" ]; then
              RANGE="HEAD"
            else
              RANGE="${LAST_TAG}..HEAD"
            fi
          else
            LAST_PRERELEASE=$(git describe --tags --abbrev=0 --match="*-pre-release.*" 2>/dev/null || echo "")
            if [ -z "$LAST_PRERELEASE" ]; then
              RANGE="-1 HEAD"
            else
              RANGE="${LAST_PRERELEASE}..HEAD"
            fi
          fi
          
          {
            echo "### âœ¨ Features"
            git log --pretty=format:"- %s (%h)" $RANGE | grep -iE "^- (feat|feature)[:(]" || echo "- No new features"
            echo ""
            echo "### ðŸ› Bug Fixes"
            git log --pretty=format:"- %s (%h)" $RANGE | grep -iE "^- (fix|bugfix|bug)[:(]" || echo "- No bug fixes"
            echo ""
            echo "### ðŸ“ Documentation"
            git log --pretty=format:"- %s (%h)" $RANGE | grep -iE "^- (docs|doc)[:(]" || echo "- No documentation changes"
            echo ""
            echo "### ðŸ”§ Other Changes"
            git log --pretty=format:"- %s (%h)" $RANGE | grep -viE "^- (feat|feature|fix|bugfix|bug|docs|doc)[:(]" || echo "- No other changes"
          } > changelog.txt
          
          {
            echo "notes<<EOF"
            cat changelog.txt
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create release package
        run: |
          # Create a clean zip with only the three required files
          zip AutoKeywordLinker-${{ steps.final_version.outputs.version }}.zip main.js manifest.json styles.css

      - name: Commit manifest changes (full release only)
        if: steps.release_type.outputs.type == 'full'
        run: |
          git config user.name github-actions[bot]
          git config user.email github-actions[bot]@users.noreply.github.com
          git add manifest.json versions.json
          git commit -m "Release version ${{ steps.final_version.outputs.version }}"
          git push

      - name: Create Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: "main.js,manifest.json,styles.css,AutoKeywordLinker-${{ steps.final_version.outputs.version }}.zip"
          tag: ${{ steps.final_version.outputs.tag }}
          name: ${{ steps.final_version.outputs.version }}
          body: ${{ steps.changelog.outputs.notes }}
          prerelease: ${{ steps.release_type.outputs.is_prerelease }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup old pre-releases
        if: steps.release_type.outputs.type == 'pre'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: releases } = await github.rest.repos.listReleases({
              owner: context.repo.owner,
              repo: context.repo.repo,
              per_page: 100
            });
            
            const preReleases = releases
              .filter(r => r.prerelease && r.tag_name.includes('-pre-release.'))
              .sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            const toDelete = preReleases.slice(25);
            
            console.log(`Found ${preReleases.length} pre-releases total, keeping 25, deleting ${toDelete.length}`);
            
            for (const release of toDelete) {
              console.log(`Deleting release: ${release.tag_name} (created ${release.created_at})`);
              
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: release.id
              });
              
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `tags/${release.tag_name}`
                });
                console.log(`Deleted tag: ${release.tag_name}`);
              } catch (e) {
                console.log(`Could not delete tag ${release.tag_name}: ${e.message}`);
              }
            }
            
            console.log('Cleanup complete!');